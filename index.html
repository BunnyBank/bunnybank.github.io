<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BunnyBank — Demo</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#f4f6f9;--card:#fff;--accent:#ff6b6b;--muted:#777}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:0}
    header{background:#ff5a67;color:#fff;padding:28px 12px 44px;text-align:center}
    header h1{margin:0;font-size:28px;letter-spacing:.5px}
    header p{margin:6px 0 0;color:rgba(255,255,255,0.9);font-size:13px}
    .wrap{max-width:920px;margin:18px auto;padding:0 12px}
    .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(20,20,30,0.06);margin-bottom:16px}
    h2,h3{margin:0 0 10px}
    input,select,button{display:block;width:100%;box-sizing:border-box;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #e6e9ee;font-size:14px}
    button{background:#2b7cff;color:#fff;border:0;cursor:pointer}
    button.secondary{background:#eee;color:#222}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #edf0f3;text-align:center;font-size:14px}
    #logoutBtn{position:fixed;right:18px;bottom:18px;padding:10px 14px;background:var(--accent);color:#fff;border:0;border-radius:8px;display:none;box-shadow:0 8px 20px rgba(0,0,0,0.12);cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px;padding:8px}
    .notice{background:#fffbe6;border-left:4px solid #ffd966;padding:10px;border-radius:6px;margin-bottom:8px}
  </style>
</head>
<body>
  <!-- Top Left Image -->
  <img src="favicon.png" alt="Logo" style="position:fixed;top:10px;left:10px;width:85px;height:85px;z-index:999;border-radius:12px;margin-top:10px;margin-left:10px;margin-bottom:10px;object-fit:cover;">
  <header>
    <h1>
      <span style="display:none"></span>
      Bunny Bank
    </h1>
    <p class="muted">Play demo — not real money</p>
  </header>
  <div class="wrap">
    <!-- LOGIN (visible by default) -->
    <div class="card" id="loginCard">
      <h2>Login</h2>
      <input id="username" placeholder="Username" autocomplete="username">
      <input id="password" type="password" placeholder="Password" autocomplete="current-password">
      <button onclick="login()">Login</button>
      <p class="muted small">Demo accounts: <strong>admin/admin123</strong>, <strong>user1/user123</strong></p>
    </div>

    <!-- USER DASHBOARD (hidden until login) -->
    <div id="userView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 id="welcomeUser">Welcome</h2>
            <div id="balances" class="muted">Balances will show here</div>
          </div>
          <div class="muted small">Default currency: CAD</div>
        </div>
      </div>

      <div class="card">
        <h3>Your Cryptos</h3>
        <div id="cryptoBalances" class="muted small">No cryptos yet</div>

        <div style="margin-top:12px"><h4>Create New Crypto (cost: 100 CAD)</h4>
          <input id="newCryptoName" placeholder="New crypto name (e.g. RabbitCoin)">
          <button onclick="createCrypto()">Create Crypto (100 CAD)</button>
        </div>

        <div style="margin-top:14px">
          <h4>Trade Crypto</h4>
          <select id="tradeCryptoName"></select>
          <input id="tradeAmount" type="number" placeholder="Amount">
          <div class="grid">
            <button onclick="buyCrypto()">Buy</button>
            <button class="secondary" onclick="sellCrypto()">Sell</button>
          </div>
          <p class="muted small" id="tradePriceNote">Price: (set by admin)</p>
        </div>
      </div>

      <div class="card">
        <h3>Send Money</h3>
        <select id="payToUser"></select>
        <input id="payAmount" type="number" placeholder="Amount (CAD)">
        <select id="payCurrency"><option value="CAD">CAD</option><option value="USD">USD</option></select>
        <button onclick="sendPayment()">Send</button>
      </div>
    </div>

    <!-- ADMIN DASHBOARD (hidden until admin login) -->
    <div id="adminView" style="display:none">
      <div class="card">
        <h3>Admin — Create Account</h3>
        <div class="grid">
          <input id="newUser" placeholder="Username">
          <input id="newPass" placeholder="Password">
        </div>
        <button onclick="createAccount()">Create Account</button>
      </div>

      <div class="card">
        <h3>Adjust Exchange Rate</h3>
        <div class="grid">
          <input id="rateSym" placeholder="Currency (e.g. USD)">
          <input id="rateVal" type="number" placeholder="Rate (1 CAD = X)">
        </div>
        <button onclick="setRate()">Update Rate</button>
      </div>

      <div class="card">
        <h3>Adjust User Balance (Reset)</h3>
        <div class="grid">
          <input id="adjUserBalance" placeholder="Username">
          <input id="adjCurrencyBalance" placeholder="Currency (CAD)">
        </div>
        <input id="adjAmountBalance" type="number" placeholder="New Amount">
        <button onclick="setBalance()">Update Balance</button>
      </div>

      <div class="card">
        <h3>Crypto Prices (Admin)</h3>
        <select id="cryptoPriceName"></select>
        <input id="cryptoPriceValue" type="number" placeholder="Price in CAD">
        <button onclick="setCryptoPrice()">Set Price</button>
        <p class="muted small">Set per-token price used when users buy/sell.</p>
      </div>

      <div class="card">
        <h3>All Users</h3>
        <table>
          <thead><tr id="userTableHead"></tr></thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <button id="logoutBtn" onclick="logout()">Logout</button>

<script>
/*
  GitHub Pages demo data (in-memory only).
  For persistence you must use the Azure backend version.
*/
let accounts = {
  admin: { password: "admin123", balance: { CAD: 1000, USD: 726.66 }, cryptos: {} },
  user1: { password: "user123", balance: { CAD: 500, USD: 363.33 }, cryptos: {} }
};
let cryptoPrices = {};   // e.g. { "RabbitCoin": 100 }
let exchangeRates = { CAD: 1, USD: 0.7266 };
let currentUser = null;

/* ---------- Utility / Init ---------- */
function hideAllDashboards() {
  document.getElementById('userView').style.display = 'none';
  document.getElementById('adminView').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
}
function showLogin() {
  document.getElementById('loginCard').style.display = 'block';
  hideAllDashboards();
  document.getElementById('welcomeUser').innerText = '';
}
function initPage() {
  // on load: show login only
  showLogin();
  populateGlobalSelects();
}
window.addEventListener('load', initPage);

/* ---------- Login / Logout ---------- */
function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if (!u || !p) { alert('Enter username and password'); return; }
  if (!accounts[u]) { alert('User not found'); return; }
  if (accounts[u].password !== p) { alert('Incorrect password'); return; }

  // Set currentUser (deep-ish copy)
  currentUser = { username: u, balance: { ...accounts[u].balance }, cryptos: { ...accounts[u].cryptos }, isAdmin: (u === 'admin') };
  // show dashboards
  document.getElementById('loginCard').style.display = 'none';
  document.getElementById('userView').style.display = 'block';
  document.getElementById('logoutBtn').style.display = 'block';
  if (currentUser.isAdmin) document.getElementById('adminView').style.display = 'block';
  document.getElementById('welcomeUser').innerText = currentUser.username;
  renderBalances();
  renderCrypto();
  populateGlobalSelects();
  if (currentUser.isAdmin) renderUserTable();
}

function logout() {
  // persist currentUser changes to accounts (demo persists in-memory)
  if (currentUser) accounts[currentUser.username] = { password: accounts[currentUser.username].password, balance: currentUser.balance, cryptos: currentUser.cryptos };
  currentUser = null;
  // show login, hide everything else
  showLogin();
}

/* ---------- Rendering ---------- */
function renderBalances() {
  if (!currentUser) return;
  const container = document.getElementById('balances');
  let html = '';
  for (const cur in currentUser.balance) {
    html += `<strong>${cur}</strong>: ${Number(currentUser.balance[cur]).toFixed(2)} <br>`;
  }
  container.innerHTML = html;
}

function renderCrypto() {
  if (!currentUser) return;
  const container = document.getElementById('cryptoBalances');
  const cryptos = currentUser.cryptos || {};
  if (Object.keys(cryptos).length === 0) {
    container.innerHTML = '<span class="muted small">You do not own any crypto yet.</span>';
    return;
  }
  let html = '';
  for (const name in cryptos) {
    const qty = cryptos[name];
    const price = cryptoPrices[name] ?? 100;
    html += `<div><strong>${name}</strong>: ${qty} — price ${price} CAD each</div>`;
  }
  container.innerHTML = html;
}

/* ---------- Dropdown population ---------- */
function populateGlobalSelects() {
  // build list of all users and global cryptos
  const users = Object.keys(accounts);
  const globalCryptos = new Set();
  Object.values(accounts).forEach(u => {
    if (u.cryptos) Object.keys(u.cryptos).forEach(c => globalCryptos.add(c));
  });

  // payToUser (exclude current user if present)
  const paySelect = document.getElementById('payToUser');
  paySelect.innerHTML = '';
  users.forEach(u => { if (!currentUser || u !== currentUser.username) paySelect.innerHTML += `<option value="${u}">${u}</option>`; });

  // tradeCryptoName: show all global cryptos (if none, add placeholder)
  const tradeSelect = document.getElementById('tradeCryptoName');
  tradeSelect.innerHTML = '';
  if (globalCryptos.size === 0) {
    tradeSelect.innerHTML = '<option value="">-- no cryptos available --</option>';
  } else {
    globalCryptos.forEach(c => tradeSelect.innerHTML += `<option value="${c}">${c}</option>`);
  }

  // admin crypto price select
  const priceSelect = document.getElementById('cryptoPriceName');
  if (priceSelect) {
    priceSelect.innerHTML = '';
    if (globalCryptos.size === 0) priceSelect.innerHTML = '<option value="">-- no cryptos --</option>';
    else globalCryptos.forEach(c => priceSelect.innerHTML += `<option value="${c}">${c}</option>`);
  }

  // admin table and trade price note
  updateTradePriceNote();
}

/* ---------- Crypto actions (user) ---------- */
function createCrypto() {
  if (!currentUser) { alert('Login first'); return; }
  const name = document.getElementById('newCryptoName').value.trim();
  if (!name) { alert('Enter a name for the crypto'); return; }
  if (currentUser.balance.CAD < 100) { alert('Not enough CAD to create crypto (cost 100 CAD)'); return; }

  // Subtract cost and add crypto to current user
  currentUser.balance.CAD -= 100;
  if (!currentUser.cryptos) currentUser.cryptos = {};
  if (currentUser.cryptos[name] === undefined) currentUser.cryptos[name] = 0;

  // Register crypto globally (ensure every account has an entry for display consistency)
  Object.keys(accounts).forEach(u => {
    if (!accounts[u].cryptos) accounts[u].cryptos = {};
    if (accounts[u].cryptos[name] === undefined) accounts[u].cryptos[name] = 0;
  });

  // set default price if not set
  if (!cryptoPrices[name]) cryptoPrices[name] = 100;

  // persist in-memory
  accounts[currentUser.username] = { password: accounts[currentUser.username].password, balance: currentUser.balance, cryptos: currentUser.cryptos };

  renderBalances(); renderCrypto(); populateGlobalSelects();
  alert(`Created crypto "${name}". Price default ${cryptoPrices[name]} CAD`);
}

async function buyCrypto() {
  if (!currentUser) { alert('Login first'); return; }
  const name = document.getElementById('tradeCryptoName').value;
  const amt = parseFloat(document.getElementById('tradeAmount').value);
  if (!name) { alert('Select a crypto'); return; }
  if (!amt || amt <= 0) { alert('Enter a valid amount'); return; }
  const price = cryptoPrices[name] ?? 100;
  const cost = price * amt;
  if (currentUser.balance.CAD < cost) { alert('Not enough CAD'); return; }

  currentUser.balance.CAD -= cost;
  currentUser.cryptos[name] = (currentUser.cryptos[name] || 0) + amt;
  accounts[currentUser.username] = { password: accounts[currentUser.username].password, balance: currentUser.balance, cryptos: currentUser.cryptos };

  renderBalances(); renderCrypto(); populateGlobalSelects();
  alert(`Bought ${amt} ${name} for ${cost.toFixed(2)} CAD`);
}

async function sellCrypto() {
  if (!currentUser) { alert('Login first'); return; }
  const name = document.getElementById('tradeCryptoName').value;
  const amt = parseFloat(document.getElementById('tradeAmount').value);
  if (!name) { alert('Select a crypto'); return; }
  if (!amt || amt <= 0) { alert('Enter a valid amount'); return; }
  if ((currentUser.cryptos[name] || 0) < amt) { alert('Not enough crypto'); return; }
  const price = cryptoPrices[name] ?? 100;
  const gain = price * amt;

  currentUser.cryptos[name] -= amt;
  currentUser.balance.CAD += gain;
  accounts[currentUser.username] = { password: accounts[currentUser.username].password, balance: currentUser.balance, cryptos: currentUser.cryptos };

  renderBalances(); renderCrypto(); populateGlobalSelects();
  alert(`Sold ${amt} ${name} for ${gain.toFixed(2)} CAD`);
}

/* ---------- Payments ---------- */
async function sendPayment() {
  if (!currentUser) { alert('Login first'); return; }
  const recipient = document.getElementById('payToUser').value;
  const amount = parseFloat(document.getElementById('payAmount').value);
  const currency = document.getElementById('payCurrency').value;
  if (!recipient || !accounts[recipient]) { alert('Select a valid recipient'); return; }
  if (!amount || amount <= 0) { alert('Enter a valid amount'); return; }
  if ((currentUser.balance[currency] || 0) < amount) { alert('Insufficient funds'); return; }

  // update balances
  currentUser.balance[currency] -= amount;
  accounts[recipient].balance[currency] = (accounts[recipient].balance[currency] || 0) + amount;

  // persist in-memory
  accounts[currentUser.username] = { password: accounts[currentUser.username].password, balance: currentUser.balance, cryptos: currentUser.cryptos };

  renderBalances();
  if (currentUser.isAdmin) renderUserTable();
  populateGlobalSelects();
  alert(`Sent ${amount.toFixed(2)} ${currency} to ${recipient}`);
}

/* ---------- Admin functions ---------- */
function createAccount() {
  if (!currentUser || !currentUser.isAdmin) { alert('Admin only'); return; }
  const u = document.getElementById('newUser').value.trim();
  const p = document.getElementById('newPass').value.trim();
  if (!u || !p) { alert('Enter username and password'); return; }
  if (accounts[u]) { alert('User already exists'); return; }
  accounts[u] = { password: p, balance: { CAD: 100, USD: 0 }, cryptos: {} };
  // ensure new user has entries for existing cryptos
  Object.keys(cryptoPrices).forEach(c => { accounts[u].cryptos[c] = 0; });
  renderUserTable(); populateGlobalSelects();
  alert(`Created ${u}`);
}

function setRate() {
  if (!currentUser || !currentUser.isAdmin) { alert('Admin only'); return; }
  const sym = document.getElementById('rateSym').value.trim();
  const val = parseFloat(document.getElementById('rateVal').value);
  if (!sym || !val) { alert('Enter currency and rate'); return; }
  exchangeRates[sym] = val;
  alert(`Set rate: 1 CAD = ${val} ${sym}`);
}

function setBalance() {
  if (!currentUser || !currentUser.isAdmin) { alert('Admin only'); return; }
  const u = document.getElementById('adjUserBalance').value.trim();
  const cur = document.getElementById('adjCurrencyBalance').value.trim();
  const amt = parseFloat(document.getElementById('adjAmountBalance').value);
  if (!u || !cur || isNaN(amt)) { alert('Enter all fields'); return; }
  if (!accounts[u]) { alert('User not found'); return; }
  accounts[u].balance[cur] = amt;
  // if admin edits themselves while logged in, reflect changes
  if (currentUser.username === u) currentUser.balance[cur] = amt;
  renderUserTable(); renderBalances();
  alert(`Updated ${u} ${cur} = ${amt}`);
}

function setCryptoPrice() {
  if (!currentUser || !currentUser.isAdmin) { alert('Admin only'); return; }
  const name = document.getElementById('cryptoPriceName').value;
  const price = parseFloat(document.getElementById('cryptoPriceValue').value);
  if (!name || isNaN(price)) { alert('Enter crypto and price'); return; }
  cryptoPrices[name] = price;
  updateTradePriceNote();
  alert(`Set ${name} price to ${price} CAD`);
}

/* ---------- Admin table ---------- */
function renderUserTable() {
  if (!currentUser || !currentUser.isAdmin) return;
  const head = document.getElementById('userTableHead');
  const body = document.getElementById('userTableBody');
  head.innerHTML = '';
  body.innerHTML = '';

  // currency columns (collect unique currencies)
  const currencySet = new Set();
  Object.values(accounts).forEach(a => Object.keys(a.balance || {}).forEach(c => currencySet.add(c)));
  const currencies = Array.from(currencySet);
  head.innerHTML = '<th>User</th>' + currencies.map(c => `<th>${c}</th>`).join('') + '<th>Cryptos</th>';
  for (const u of Object.keys(accounts)) {
    const rowVals = currencies.map(c => `<td>${(accounts[u].balance[c] ?? 0).toFixed ? (accounts[u].balance[c] ?? 0).toFixed(2) : (accounts[u].balance[c] ?? 0)}</td>`).join('');
    // crypto summary
    const cryptoSummary = Object.entries(accounts[u].cryptos || {}).map(([k,v]) => `${k}: ${v}`).join(', ') || '-';
    body.innerHTML += `<tr><td>${u}</td>${rowVals}<td style="text-align:left;padding-left:10px">${cryptoSummary}</td></tr>`;
  }
}

/* ---------- Helpers ---------- */
function updateTradePriceNote() {
  const sel = document.getElementById('tradeCryptoName');
  const note = document.getElementById('tradePriceNote');
  const name = sel ? sel.value : null;
  if (!name) { note.innerText = 'Price: (set by admin)'; return; }
  const p = cryptoPrices[name] ?? 100;
  note.innerText = `Price: ${p} CAD each`;
}

/* --- hook: update price note when user changes crypto selection --- */
document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'tradeCryptoName') updateTradePriceNote();
});

/* ensure dropdowns update when page loads */
populateGlobalSelects();
</script>
</body>
</html>
